import 'dart:convert';
import 'dart:io';
import 'package:shelf/shelf.dart';
import 'package:shelf/shelf_io.dart' as shelf_io;
import 'package:shelf_router/shelf_router.dart';
import 'package:sqlite3/sqlite3.dart';
import 'package:crypto/crypto.dart';
import 'package:dart_jsonwebtoken/dart_jsonwebtoken.dart';
import 'subscription_handlers.dart' as sub;
import 'product_handlers.dart' as prod;

const String secretKey = 'your-super-secret-key-change-this-2024';
const int port = 53365;
const String dbPath = 'database.db';

Database? db;

void main() async {
  db = sqlite3.open('database.db');
  
  db!.execute('''
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE NOT NULL,
      password TEXT NOT NULL,
      name TEXT NOT NULL,
      role TEXT DEFAULT 'employee',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  ''');

  // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ name Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
  try {
    db!.execute('ALTER TABLE users ADD COLUMN name TEXT DEFAULT ""');
    print('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  } catch (e) {
    // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  }

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
  db!.execute('''
    CREATE TABLE IF NOT EXISTS subscriptions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      service_name TEXT NOT NULL,
      account_number TEXT,
      cost REAL NOT NULL,
      max_users INTEGER NOT NULL,
      current_users INTEGER DEFAULT 0,
      start_date TEXT NOT NULL,
      end_date TEXT NOT NULL,
      email TEXT,
      password TEXT,
      created_by INTEGER,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (created_by) REFERENCES users(id)
    )
  ''');

  // Ø¬Ø¯ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
  db!.execute('''
    CREATE TABLE IF NOT EXISTS subscription_users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      subscription_id INTEGER NOT NULL,
      customer_name TEXT NOT NULL,
      profile_name TEXT NOT NULL,
      amount REAL NOT NULL,
      start_date TEXT NOT NULL,
      end_date TEXT NOT NULL,
      added_by TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (subscription_id) REFERENCES subscriptions(id) ON DELETE CASCADE
    )
  ''');

  final adminPassword = hashPassword('admin123');
  try {
    db!.execute('''
      INSERT INTO users (username, password, name, role) 
      VALUES ('admin', '$adminPassword', 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', 'admin')
    ''');
    print('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±');
  } catch (e) {
    print('Admin user already exists');
    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
    db!.execute('''
      UPDATE users SET name = 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' WHERE username = 'admin' AND (name IS NULL OR name = '')
    ''');
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©)
  final subsCount = db!.select('SELECT COUNT(*) as count FROM subscriptions').first['count'];
  if (subsCount == 0) {
    print('ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª...');
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Netflix
    db!.execute('''
      INSERT INTO subscriptions (service_name, account_number, cost, max_users, start_date, end_date, email, password, created_by)
      VALUES ('Netflix', 'NF-12345', 15000, 5, '2025-01-01', '2025-12-31', 'netflix@example.com', 'pass123', 1)
    ''');
    
    final netflixId = db!.select('SELECT last_insert_rowid() as id').first['id'];
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù€ Netflix
    db!.execute('''
      INSERT INTO subscription_users (subscription_id, customer_name, profile_name, amount, start_date, end_date, added_by)
      VALUES (?, 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', 'Profile 1', 3000, '2025-01-01', '2025-02-01', 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…')
    ''', [netflixId]);
    
    db!.execute('''
      INSERT INTO subscription_users (subscription_id, customer_name, profile_name, amount, start_date, end_date, added_by)
      VALUES (?, 'ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ', 'Profile 2', 3000, '2025-01-05', '2025-02-05', 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…')
    ''', [netflixId]);
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Shahid
    db!.execute('''
      INSERT INTO subscriptions (service_name, account_number, cost, max_users, start_date, end_date, email, password, created_by)
      VALUES ('Shahid VIP', 'SH-98765', 12000, 4, '2025-01-15', '2025-12-15', 'shahid@example.com', 'shahid456', 1)
    ''');
    
    final shahidId = db!.select('SELECT last_insert_rowid() as id').first['id'];
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù€ Shahid
    db!.execute('''
      INSERT INTO subscription_users (subscription_id, customer_name, profile_name, amount, start_date, end_date, added_by)
      VALUES (?, 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†', 'VIP Profile', 3000, '2025-01-15', '2025-02-15', 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…')
    ''', [shahidId]);
    
    print('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
  }

  final router = Router()
    ..post('/api/login', _loginHandler)
    ..post('/api/users/create', _createUserHandler)
    ..delete('/api/users/<id>', _deleteUserHandler)
    ..put('/api/users/<id>/password', _changePasswordHandler)
    ..get('/api/users/list', _getUsersListHandler)
    ..get('/api/health', _healthHandler)
    ..get('/api/protected', _protectedHandler)
    // Subscriptions routes
    ..get('/api/subscriptions', (request) => sub.getSubscriptionsHandler(request, db!))
    ..post('/api/subscriptions', (request) => sub.createSubscriptionHandler(request, db!))
    ..put('/api/subscriptions/<id>', (request, id) => sub.updateSubscriptionHandler(request, id, db!))
    ..delete('/api/subscriptions/<id>', (request, id) => sub.deleteSubscriptionHandler(request, id, db!))
    ..get('/api/subscriptions/<id>/users', (request, id) => sub.getSubscriptionUsersHandler(request, id, db!))
    ..post('/api/subscriptions/<id>/users', (request, id) => sub.addSubscriptionUserHandler(request, id, db!))
    ..put('/api/subscription-users/<id>', (request, id) => sub.updateSubscriptionUserHandler(request, id, db!))
    ..put('/api/subscription-users/<id>/extend', (request, id) => sub.extendSubscriptionUserHandler(request, id, db!))
    ..delete('/api/subscription-users/<id>', (request, id) => sub.deleteSubscriptionUserHandler(request, id, db!));
    // Products routes
    ..get('/api/products', (request) => prod.getProducts(request, db!))
    ..get('/api/products/category/<category>', (request, category) => prod.getProductsByCategory(request, db!, category))
    ..post('/api/products', (request) => prod.createProduct(request, db!))
    ..put('/api/products/<id>', (request, id) => prod.updateProduct(request, db!, id))
    ..delete('/api/products/<id>', (request, id) => prod.deleteProduct(request, db!, id));

  final handler = const Pipeline()
      .addMiddleware(_corsMiddleware())
      .addMiddleware(logRequests())
      .addHandler(router);

  final server = await shelf_io.serve(
    handler,
    '127.0.0.1',
    port,
  );

  print('ğŸš€ API ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° $port');
  print('âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø±: admin.taif.digital');
  print('ğŸ“Š Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: database.db');
  print('ğŸ‘¤ Ø­Ø³Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ: admin / admin123');
}

Middleware _corsMiddleware() {
  return (Handler handler) {
    return (Request request) async {
      if (request.method == 'OPTIONS') {
        return Response.ok('', headers: _corsHeaders());
      }

      final response = await handler(request);
      return response.change(headers: _corsHeaders());
    };
  };
}

Map<String, String> _corsHeaders() {
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Origin, Content-Type, Authorization',
  };
}

String hashPassword(String password) {
  final bytes = utf8.encode(password);
  final digest = sha256.convert(bytes);
  return digest.toString();
}

Future<Response> _loginHandler(Request request) async {
  try {
    final body = await request.readAsString();
    final data = jsonDecode(body);

    final username = data['username'];
    final password = data['password'];

    if (username == null || password == null) {
      return Response(400,
          body: jsonEncode({
            'success': false,
            'message': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'
          }),
          headers: {'Content-Type': 'application/json'});
    }

    final hashedPassword = hashPassword(password);
    final result = db!.select(
        'SELECT * FROM users WHERE username = ? AND password = ?',
        [username, hashedPassword]);

    if (result.isEmpty) {
      return Response(401,
          body: jsonEncode({
            'success': false,
            'message': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
          }),
          headers: {'Content-Type': 'application/json'});
    }

    final user = result.first;
    final jwt = JWT({
      'id': user['id'],
      'username': user['username'],
      'name': user['name'] ?? user['username'],
      'role': user['role'],
      'exp': DateTime.now().add(Duration(hours: 24)).millisecondsSinceEpoch,
    });

    final token = jwt.sign(SecretKey(secretKey));

    return Response.ok(
        jsonEncode({
          'success': true,
          'message': 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
          'token': token,
          'user': {
            'id': user['id'],
            'username': user['username'],
            'name': user['name'] ?? user['username'],
            'role': user['role'],
          }
        }),
        headers: {'Content-Type': 'application/json'});
  } catch (e) {
    return Response.internalServerError(
        body: jsonEncode({'success': false, 'message': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: $e'}),
        headers: {'Content-Type': 'application/json'});
  }
}

Future<Response> _healthHandler(Request request) async {
  return Response.ok(
      jsonEncode({'status': 'ok', 'message': 'API ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­'}),
      headers: {'Content-Type': 'application/json'});
}

Future<Response> _protectedHandler(Request request) async {
  final authHeader = request.headers['authorization'];
  
  if (authHeader == null || !authHeader.startsWith('Bearer ')) {
    return Response(401,
        body: jsonEncode({'success': false, 'message': 'ØºÙŠØ± Ù…ØµØ±Ø­'}),
        headers: {'Content-Type': 'application/json'});
  }

  final token = authHeader.substring(7);

  try {
    final jwt = JWT.verify(token, SecretKey(secretKey));
    
    return Response.ok(
        jsonEncode({
          'success': true,
          'message': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!',
          'user': jwt.payload
        }),
        headers: {'Content-Type': 'application/json'});
  } catch (e) {
    return Response(403,
        body: jsonEncode({'success': false, 'message': 'Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©'}),
        headers: {'Content-Type': 'application/json'});
  }
}

Future<Response> _createUserHandler(Request request) async {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
    final authHeader = request.headers['authorization'];
    
    if (authHeader == null || !authHeader.startsWith('Bearer ')) {
      return Response(401,
          body: jsonEncode({'success': false, 'message': 'ØºÙŠØ± Ù…ØµØ±Ø­'}),
          headers: {'Content-Type': 'application/json'});
    }

    final token = authHeader.substring(7);
    late JWT jwt;

    try {
      jwt = JWT.verify(token, SecretKey(secretKey));
    } catch (e) {
      return Response(403,
          body: jsonEncode({'success': false, 'message': 'Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©'}),
          headers: {'Content-Type': 'application/json'});
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±
    if (jwt.payload['role'] != 'admin') {
      return Response(403,
          body: jsonEncode({'success': false, 'message': 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©'}),
          headers: {'Content-Type': 'application/json'});
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    final body = await request.readAsString();
    final data = jsonDecode(body);

    final username = data['username'];
    final password = data['password'];
    final name = data['name'];
    final role = data['role'] ?? 'employee';

    if (username == null || password == null || name == null) {
      return Response(400,
          body: jsonEncode({
            'success': false,
            'message': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'
          }),
          headers: {'Content-Type': 'application/json'});
    }

    final db = sqlite3.open(dbPath);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    final existing = db.select(
        'SELECT id FROM users WHERE username = ?', [username]);

    if (existing.isNotEmpty) {
      db.dispose();
      return Response(400,
          body: jsonEncode({
            'success': false,
            'message': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹'
          }),
          headers: {'Content-Type': 'application/json'});
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    final hashedPassword = hashPassword(password);
    db.execute('''
      INSERT INTO users (username, password, name, role)
      VALUES (?, ?, ?, ?)
    ''', [username, hashedPassword, name, role]);

    db.dispose();

    print('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: $name ($username - $role)');

    return Response.ok(
        jsonEncode({
          'success': true,
          'message': 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­'
        }),
        headers: {'Content-Type': 'application/json'});
  } catch (e) {
    return Response.internalServerError(
        body: jsonEncode({'success': false, 'message': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: $e'}),
        headers: {'Content-Type': 'application/json'});
  }
}

Future<Response> _getUsersListHandler(Request request) async {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
    final authHeader = request.headers['authorization'];
    
    if (authHeader == null || !authHeader.startsWith('Bearer ')) {
      return Response(401,
          body: jsonEncode({'success': false, 'message': 'ØºÙŠØ± Ù…ØµØ±Ø­'}),
          headers: {'Content-Type': 'application/json'});
    }

    final token = authHeader.substring(7);
    late JWT jwt;

    try {
      jwt = JWT.verify(token, SecretKey(secretKey));
    } catch (e) {
      return Response(403,
          body: jsonEncode({'success': false, 'message': 'Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©'}),
          headers: {'Content-Type': 'application/json'});
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±
    if (jwt.payload['role'] != 'admin') {
      return Response(403,
          body: jsonEncode({'success': false, 'message': 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©'}),
          headers: {'Content-Type': 'application/json'});
    }

    final db = sqlite3.open(dbPath);

    final result = db.select('SELECT id, username, name, role FROM users');

    final users = result.map((row) {
      return {
        'id': row['id'],
        'username': row['username'],
        'name': row['name'] ?? row['username'],
        'role': row['role'],
      };
    }).toList();

    db.dispose();

    return Response.ok(
        jsonEncode({
          'success': true,
          'users': users
        }),
        headers: {'Content-Type': 'application/json'});
  } catch (e) {
    return Response.internalServerError(
        body: jsonEncode({'success': false, 'message': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: $e'}),
        headers: {'Content-Type': 'application/json'});
  }
}

Future<Response> _deleteUserHandler(Request request, String id) async {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
    final authHeader = request.headers['authorization'];
    if (authHeader == null || !authHeader.startsWith('Bearer ')) {
      return Response.unauthorized(
          jsonEncode({'success': false, 'message': 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'}),
          headers: {'Content-Type': 'application/json'});
    }

    final token = authHeader.substring(7);
    final jwt = JWT.verify(token, SecretKey(secretKey));
    final payload = jwt.payload;
    final currentUserId = payload['id'];
    final currentUserRole = payload['role'];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±
    if (currentUserRole != 'admin') {
      return Response.forbidden(
          jsonEncode({'success': false, 'message': 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'}),
          headers: {'Content-Type': 'application/json'});
    }

    final userId = int.tryParse(id);
    if (userId == null) {
      return Response.badRequest(
          body: jsonEncode({'success': false, 'message': 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­'}),
          headers: {'Content-Type': 'application/json'});
    }

    // Ù…Ù†Ø¹ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ
    if (userId == currentUserId) {
      return Response.badRequest(
          body: jsonEncode({'success': false, 'message': 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ'}),
          headers: {'Content-Type': 'application/json'});
    }

    final db = sqlite3.open(dbPath);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    final checkResult = db.select('SELECT id FROM users WHERE id = ?', [userId]);
    if (checkResult.isEmpty) {
      db.dispose();
      return Response.notFound(
          jsonEncode({'success': false, 'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}),
          headers: {'Content-Type': 'application/json'});
    }

    // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    db.execute('DELETE FROM users WHERE id = ?', [userId]);
    db.dispose();

    print('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ID $userId Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ID $currentUserId');

    return Response.ok(
        jsonEncode({
          'success': true,
          'message': 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­'
        }),
        headers: {'Content-Type': 'application/json'});
  } catch (e) {
    return Response.internalServerError(
        body: jsonEncode({'success': false, 'message': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: $e'}),
        headers: {'Content-Type': 'application/json'});
  }
}

Future<Response> _changePasswordHandler(Request request, String id) async {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
    final authHeader = request.headers['authorization'];
    if (authHeader == null || !authHeader.startsWith('Bearer ')) {
      return Response.unauthorized(
          jsonEncode({'success': false, 'message': 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'}),
          headers: {'Content-Type': 'application/json'});
    }

    final token = authHeader.substring(7);
    final jwt = JWT.verify(token, SecretKey(secretKey));
    final payload = jwt.payload;
    final currentUserId = payload['id'];
    final currentUserRole = payload['role'];

    final userId = int.tryParse(id);
    if (userId == null) {
      return Response.badRequest(
          body: jsonEncode({'success': false, 'message': 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­'}),
          headers: {'Content-Type': 'application/json'});
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    if (currentUserRole != 'admin' && currentUserId != userId) {
      return Response.forbidden(
          jsonEncode({'success': false, 'message': 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'}),
          headers: {'Content-Type': 'application/json'});
    }

    final requestBody = await request.readAsString();
    final data = jsonDecode(requestBody);
    final newPassword = data['newPassword'];

    if (newPassword == null || newPassword.isEmpty) {
      return Response.badRequest(
          body: jsonEncode({'success': false, 'message': 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'}),
          headers: {'Content-Type': 'application/json'});
    }

    if (newPassword.length < 6) {
      return Response.badRequest(
          body: jsonEncode({'success': false, 'message': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'}),
          headers: {'Content-Type': 'application/json'});
    }

    final db = sqlite3.open(dbPath);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    final checkResult = db.select('SELECT id FROM users WHERE id = ?', [userId]);
    if (checkResult.isEmpty) {
      db.dispose();
      return Response.notFound(
          jsonEncode({'success': false, 'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}),
          headers: {'Content-Type': 'application/json'});
    }

    // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    final hashedPassword = sha256.convert(utf8.encode(newPassword)).toString();

    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    db.execute('UPDATE users SET password = ? WHERE id = ?', [hashedPassword, userId]);
    db.dispose();

    print('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ID $userId');

    return Response.ok(
        jsonEncode({
          'success': true,
          'message': 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­'
        }),
        headers: {'Content-Type': 'application/json'});
  } catch (e) {
    return Response.internalServerError(
        body: jsonEncode({'success': false, 'message': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: $e'}),
        headers: {'Content-Type': 'application/json'});
  }
}
